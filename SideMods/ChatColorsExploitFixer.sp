#include <sourcemod>
#include <chat-processor>

#pragma semicolon 1
#pragma newdecls required

char g_Symbols[][] = { "", "", "", "", "", "", "", "", "", "", "", "", "	" };

bool g_IsAdmin[MAXPLAYERS + 1];

public Plugin myinfo = 
{
	name = "[CS:GO] Chat Colors Exploit Fixer", 
	author = "KoNLiG", 
	description = "Block color messages for CS:GO servers.", 
	version = "1.0.0", 
	url = "https://steamcommunity.com/id/KoNLiG/ || KoNLiG#6417"
};

public void OnRebuildAdminCache(AdminCachePart part)
{
	Lateload();
}

public void OnClientPostAdminCheck(int client)
{
	g_IsAdmin[client] = (GetUserAdmin(client) != INVALID_ADMIN_ID);
}

public void OnClientDisconnect(int client)
{
	g_IsAdmin[client] = false;
}

public Action CP_OnChatMessage(int &author, ArrayList recipients, char[] flagstring, char[] name, char[] message, bool &processcolors, bool &removecolors)
{
	if (g_IsAdmin[author])
	{
		return Plugin_Continue;
	}
	
	bool replaced;
	
	for (int current_symbol = 0; current_symbol < sizeof(g_Symbols); current_symbol++)
	{
		while (StrContains(message, g_Symbols[current_symbol]) != -1 && !(GetUserAdmin(author) != INVALID_ADMIN_ID && current_symbol == 1))
		{
			ReplaceString(message, MAXLENGTH_MESSAGE * 2, g_Symbols[current_symbol], "");
			replaced = true;
		}
	}
	
	return replaced ? Plugin_Changed : Plugin_Continue;
}

void Lateload()
{
	for (int current_client = 1; current_client <= MaxClients; current_client++)
	{
		if (IsClientInGame(current_client))
		{
			OnClientPostAdminCheck(current_client);
		}
	}
} 